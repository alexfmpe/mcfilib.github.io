<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Philip is a Ruby and Haskell developer currently working remotely from Penarth.">
    <title>
      Philip Cunningham -
      
      Testing distributed-process Apps Using Hspec
      
    </title>
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/filib.css">
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="column one-third">
          <nav class="masthead">
            <ul>
              <li>
                <a href="../">
                  Home
                </a>
              </li>
              </li>
              <li>
                <a href="../about.html">
                  About
                </a>
              </li>
              <li>
                <a href="../rss.xml">
                  RSS
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
      <hr />
      <div class="row">
        <div>
  <h1>
    Testing distributed-process Apps Using Hspec
  </h1>
  <section>
    <header>
      <h2>
        2018-12-24
      </h2>
      <p>
        <a href="../tags/distributed-process.html" class="post-category green">distributed-process</a> <a href="../tags/haskell.html" class="post-category green">haskell</a> <a href="../tags/hspec.html" class="post-category green">hspec</a> <a href="../tags/testing.html" class="post-category green">testing</a>
      </p>
    </header>

    <div>
      <p><a href="https://github.com/haskell-distributed/distributed-process"><code>distributed-process</code></a> is a Haskell library that brings Erlang-style concurrency to Haskell. Whilst developing an application at work that uses it, I found that there wasnâ€™t much material online describing how to test <a href="https://github.com/haskell-distributed/distributed-process"><code>distributed-process</code></a> applications. I used some techniques from object-oriented programming that allowed me to test the behaviour of my application whilst I was learning how it was supposed to fit together. This post documents some techniques I found useful.</p>
<h2 id="application">Application</h2>
<p>Our example revolves around a fairly simple <a href="https://en.wikipedia.org/wiki/Client%E2%80%93server_model">client-server</a> application. The client process can send data to the server and output responses to the console, whilst the server performs calculations and sends the results back to clients.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="ot">{-# LANGUAGE DeriveGeneric #-}</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="ot">{-# LANGUAGE NoImplicitPrelude #-}</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="ot">{-# LANGUAGE TupleSections #-}</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="kw">import</span> <span class="dt">Control.Distributed.Process</span> (<span class="dt">Process</span>, <span class="dt">ProcessId</span>, expect, getSelfPid, register, say, send, whereis)</a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="kw">import</span> <span class="dt">Control.Distributed.Process.Node</span> (<span class="dt">LocalNode</span>, initRemoteTable, forkProcess, newLocalNode, runProcess)</a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="kw">import</span> <span class="dt">Data.Binary</span> (<span class="dt">Binary</span>)</a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="kw">import</span> <span class="dt">Network.Transport</span> (<span class="dt">Transport</span>(..))</a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="kw">import</span> <span class="dt">Network.Transport.TCP</span> (createTransport, defaultTCPParameters)</a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="kw">import</span> <span class="dt">Prelude</span> (<span class="dt">String</span>)</a>
<a class="sourceLine" id="cb1-15" data-line-number="15"><span class="kw">import</span> <span class="dt">Protolude</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="kw">import</span> <span class="dt">Test.Hspec</span></a>
<a class="sourceLine" id="cb1-17" data-line-number="17"></a>
<a class="sourceLine" id="cb1-18" data-line-number="18"></a>
<a class="sourceLine" id="cb1-19" data-line-number="19"><span class="co">-- APP</span></a>
<a class="sourceLine" id="cb1-20" data-line-number="20"></a>
<a class="sourceLine" id="cb1-21" data-line-number="21"></a>
<a class="sourceLine" id="cb1-22" data-line-number="22"><span class="ot">app ::</span> <span class="dt">LocalNode</span> <span class="ot">-&gt;</span> <span class="dt">Process</span> ()</a>
<a class="sourceLine" id="cb1-23" data-line-number="23">app node <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-24" data-line-number="24">  _ <span class="ot">&lt;-</span> newProcess node <span class="st">&quot;client&quot;</span> clientProcess</a>
<a class="sourceLine" id="cb1-25" data-line-number="25">  _ <span class="ot">&lt;-</span> newProcess node <span class="st">&quot;server&quot;</span> serverProcess</a>
<a class="sourceLine" id="cb1-26" data-line-number="26">  pure ()</a>
<a class="sourceLine" id="cb1-27" data-line-number="27"></a>
<a class="sourceLine" id="cb1-28" data-line-number="28"></a>
<a class="sourceLine" id="cb1-29" data-line-number="29"><span class="co">-- PROCESSES</span></a>
<a class="sourceLine" id="cb1-30" data-line-number="30"></a>
<a class="sourceLine" id="cb1-31" data-line-number="31"></a>
<a class="sourceLine" id="cb1-32" data-line-number="32"><span class="kw">data</span> <span class="dt">ClientMsg</span> <span class="fu">=</span></a>
<a class="sourceLine" id="cb1-33" data-line-number="33">      <span class="dt">Ask</span> [<span class="dt">Int</span>]</a>
<a class="sourceLine" id="cb1-34" data-line-number="34">    <span class="fu">|</span> <span class="dt">Result</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb1-35" data-line-number="35">    <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Generic</span>, <span class="dt">Show</span>)</a>
<a class="sourceLine" id="cb1-36" data-line-number="36"></a>
<a class="sourceLine" id="cb1-37" data-line-number="37"><span class="kw">instance</span> <span class="dt">Binary</span> <span class="dt">ClientMsg</span></a>
<a class="sourceLine" id="cb1-38" data-line-number="38"></a>
<a class="sourceLine" id="cb1-39" data-line-number="39"></a>
<a class="sourceLine" id="cb1-40" data-line-number="40"><span class="ot">clientProcess ::</span> <span class="dt">Process</span> ()</a>
<a class="sourceLine" id="cb1-41" data-line-number="41">clientProcess <span class="fu">=</span> forever <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-42" data-line-number="42">  msg <span class="ot">&lt;-</span> expect</a>
<a class="sourceLine" id="cb1-43" data-line-number="43"></a>
<a class="sourceLine" id="cb1-44" data-line-number="44">  <span class="kw">case</span> msg <span class="kw">of</span></a>
<a class="sourceLine" id="cb1-45" data-line-number="45">    <span class="dt">Ask</span> ints <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-46" data-line-number="46">      self <span class="ot">&lt;-</span> getSelfPid</a>
<a class="sourceLine" id="cb1-47" data-line-number="47">      namedSend <span class="st">&quot;server&quot;</span> <span class="fu">$</span> <span class="dt">Calc</span> self ints</a>
<a class="sourceLine" id="cb1-48" data-line-number="48"></a>
<a class="sourceLine" id="cb1-49" data-line-number="49">    <span class="dt">Result</span> n <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb1-50" data-line-number="50">      say <span class="fu">$</span> <span class="st">&quot;received: &quot;</span> <span class="fu">&lt;&gt;</span> show n</a>
<a class="sourceLine" id="cb1-51" data-line-number="51"></a>
<a class="sourceLine" id="cb1-52" data-line-number="52"></a>
<a class="sourceLine" id="cb1-53" data-line-number="53"><span class="kw">data</span> <span class="dt">ServerMsg</span> <span class="fu">=</span></a>
<a class="sourceLine" id="cb1-54" data-line-number="54">  <span class="dt">Calc</span> <span class="dt">ProcessId</span> [<span class="dt">Int</span>]</a>
<a class="sourceLine" id="cb1-55" data-line-number="55">  <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Generic</span>, <span class="dt">Show</span>)</a>
<a class="sourceLine" id="cb1-56" data-line-number="56"></a>
<a class="sourceLine" id="cb1-57" data-line-number="57"></a>
<a class="sourceLine" id="cb1-58" data-line-number="58"><span class="kw">instance</span> <span class="dt">Binary</span> <span class="dt">ServerMsg</span></a>
<a class="sourceLine" id="cb1-59" data-line-number="59"></a>
<a class="sourceLine" id="cb1-60" data-line-number="60"></a>
<a class="sourceLine" id="cb1-61" data-line-number="61"><span class="ot">serverProcess ::</span> <span class="dt">Process</span> ()</a>
<a class="sourceLine" id="cb1-62" data-line-number="62">serverProcess <span class="fu">=</span> forever <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-63" data-line-number="63">  msg <span class="ot">&lt;-</span> expect</a>
<a class="sourceLine" id="cb1-64" data-line-number="64"></a>
<a class="sourceLine" id="cb1-65" data-line-number="65">  <span class="kw">case</span> msg <span class="kw">of</span></a>
<a class="sourceLine" id="cb1-66" data-line-number="66">    <span class="dt">Calc</span> sender ints <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-67" data-line-number="67">      send sender <span class="fu">$</span> <span class="dt">Result</span> (sum ints)</a></code></pre></div>
<p>The code above uses some helper functions that arenâ€™t present in <a href="https://github.com/haskell-distributed/distributed-process"><code>distributed-process</code></a>; these are included in the code below to let you follow along at home.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co">-- PROCESS HELPERS</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="co">-- | Fork process and register it</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="ot">newProcess ::</span> <span class="dt">LocalNode</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Process</span> () <span class="ot">-&gt;</span> <span class="dt">Process</span> <span class="dt">ProcessId</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">newProcess node name process <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">  pid <span class="ot">&lt;-</span> liftIO <span class="fu">$</span> forkProcess node process</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">  _ <span class="ot">&lt;-</span> register name pid</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">  pure pid</a>
<a class="sourceLine" id="cb2-10" data-line-number="10"></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="co">-- | Create a new transport</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="ot">newTransport ::</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">IOException</span> <span class="dt">Transport</span>)</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">newTransport <span class="fu">=</span></a>
<a class="sourceLine" id="cb2-15" data-line-number="15">  <span class="kw">let</span></a>
<a class="sourceLine" id="cb2-16" data-line-number="16">    host <span class="fu">=</span></a>
<a class="sourceLine" id="cb2-17" data-line-number="17">      <span class="st">&quot;localhost&quot;</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18">    port <span class="fu">=</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19">      <span class="st">&quot;3000&quot;</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20">  <span class="kw">in</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21">    createTransport host port (host,) defaultTCPParameters</a>
<a class="sourceLine" id="cb2-22" data-line-number="22"></a>
<a class="sourceLine" id="cb2-23" data-line-number="23"></a>
<a class="sourceLine" id="cb2-24" data-line-number="24"><span class="co">-- | Spins up an application</span></a>
<a class="sourceLine" id="cb2-25" data-line-number="25"><span class="ot">run ::</span> (<span class="dt">LocalNode</span> <span class="ot">-&gt;</span> <span class="dt">Process</span> ()) <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">LocalNode</span>, <span class="dt">Transport</span>)</a>
<a class="sourceLine" id="cb2-26" data-line-number="26">run app <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-27" data-line-number="27">  eitherTrans <span class="ot">&lt;-</span> newTransport</a>
<a class="sourceLine" id="cb2-28" data-line-number="28"></a>
<a class="sourceLine" id="cb2-29" data-line-number="29">  <span class="kw">case</span> eitherTrans <span class="kw">of</span></a>
<a class="sourceLine" id="cb2-30" data-line-number="30">    <span class="dt">Left</span> err <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb2-31" data-line-number="31">      panic <span class="fu">$</span> show err</a>
<a class="sourceLine" id="cb2-32" data-line-number="32"></a>
<a class="sourceLine" id="cb2-33" data-line-number="33">    <span class="dt">Right</span> transport <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-34" data-line-number="34">      node <span class="ot">&lt;-</span> newLocalNode transport initRemoteTable</a>
<a class="sourceLine" id="cb2-35" data-line-number="35">      _    <span class="ot">&lt;-</span> runProcess node (app node)</a>
<a class="sourceLine" id="cb2-36" data-line-number="36"></a>
<a class="sourceLine" id="cb2-37" data-line-number="37">      pure (node, transport)</a>
<a class="sourceLine" id="cb2-38" data-line-number="38"></a>
<a class="sourceLine" id="cb2-39" data-line-number="39"></a>
<a class="sourceLine" id="cb2-40" data-line-number="40"><span class="co">-- | Sends to a named process</span></a>
<a class="sourceLine" id="cb2-41" data-line-number="41"><span class="ot">namedSend ::</span> (<span class="dt">Binary</span> a, <span class="dt">Typeable</span> a) <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Process</span> ()</a>
<a class="sourceLine" id="cb2-42" data-line-number="42">namedSend name msg <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-43" data-line-number="43">  mbPid <span class="ot">&lt;-</span> whereis name</a>
<a class="sourceLine" id="cb2-44" data-line-number="44"></a>
<a class="sourceLine" id="cb2-45" data-line-number="45">  <span class="kw">case</span> mbPid <span class="kw">of</span></a>
<a class="sourceLine" id="cb2-46" data-line-number="46">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb2-47" data-line-number="47">      say <span class="st">&quot;process not registered&quot;</span></a>
<a class="sourceLine" id="cb2-48" data-line-number="48"></a>
<a class="sourceLine" id="cb2-49" data-line-number="49">    <span class="dt">Just</span> pid <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb2-50" data-line-number="50">       send pid msg</a></code></pre></div>
<h2 id="testing">Testing</h2>
<p>Weâ€™ll start off by writing a custom <a href="https://hspec.github.io/writing-specs.html">HSpec</a> hook to make a bridge between our application and our tests. Our hook will spin up an application and thread around a shared <a href="http://hackage.haskell.org/package/base-4.12.0.0/docs/Control-Concurrent-MVar.html#t:MVar"><code>MVar</code></a> and a <a href="http://hackage.haskell.org/package/distributed-process-0.7.4/docs/Control-Distributed-Process-Node.html#t:LocalNode"><code>LocalNode</code></a>.</p>
<p>The <a href="http://hackage.haskell.org/package/base-4.12.0.0/docs/Control-Concurrent-MVar.html#t:MVar"><code>MVar</code></a> serves two purposes; it will be used to communicate state and act as locking mechanism (<a href="http://hackage.haskell.org/package/base-4.12.0.0/docs/Control-Concurrent-MVar.html#v:takeMVar"><code>takeMVar</code></a> blocks until itâ€™s full). Whilst the <a href="http://hackage.haskell.org/package/distributed-process-0.7.4/docs/Control-Distributed-Process-Node.html#t:LocalNode"><code>LocalNode</code></a> will allow us to spin up adhoc processes when we need them.</p>
<p>The functions <code>aroundApp</code> and <code>withApp</code> are the first step in bridging these two worlds.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co">-- SPEC HELPERS</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co">-- | Spins up and tears down app and passing along an mvar</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="ot">aroundApp ::</span> (<span class="dt">MVar</span> a <span class="ot">-&gt;</span> <span class="dt">LocalNode</span> <span class="ot">-&gt;</span> <span class="dt">Process</span> ())</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">          <span class="ot">-&gt;</span> <span class="dt">SpecWith</span> (<span class="dt">MVar</span> a, <span class="dt">LocalNode</span>)</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">          <span class="ot">-&gt;</span> <span class="dt">Spec</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8">aroundApp app <span class="fu">=</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9">  around <span class="fu">$</span> withApp app</a>
<a class="sourceLine" id="cb3-10" data-line-number="10"></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="co">-- | Spins up application, closes it cleanly and passes along an mvar</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="ot">withApp ::</span> (<span class="dt">MVar</span> a <span class="ot">-&gt;</span> <span class="dt">LocalNode</span> <span class="ot">-&gt;</span> <span class="dt">Process</span> ())</a>
<a class="sourceLine" id="cb3-14" data-line-number="14">        <span class="ot">-&gt;</span> (((<span class="dt">MVar</span> a, <span class="dt">LocalNode</span>) <span class="ot">-&gt;</span> <span class="dt">IO</span> ()) <span class="ot">-&gt;</span> <span class="dt">IO</span> ())</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">withApp app action <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16">  mvar              <span class="ot">&lt;-</span> newEmptyMVar</a>
<a class="sourceLine" id="cb3-17" data-line-number="17">  (node, transport) <span class="ot">&lt;-</span> run <span class="fu">$</span> app mvar</a>
<a class="sourceLine" id="cb3-18" data-line-number="18">  _                 <span class="ot">&lt;-</span> finally (action (mvar, node)) (closeTransport transport)</a>
<a class="sourceLine" id="cb3-19" data-line-number="19">  closeTransport transport</a></code></pre></div>
<p>The second step in bridging these words is defining a function thatâ€™ll listen for messages that are sent to a process and put them in our <a href="http://hackage.haskell.org/package/base-4.12.0.0/docs/Control-Concurrent-MVar.html#t:MVar"><code>MVar</code></a>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co">-- | Listens for messages and writes msg to an mvar</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="ot">writer ::</span> (<span class="dt">Binary</span> a, <span class="dt">Show</span> a, <span class="dt">Typeable</span> a) <span class="ot">=&gt;</span> <span class="dt">MVar</span> a <span class="ot">-&gt;</span> <span class="dt">Process</span> ()</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">writer mvar <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  msg <span class="ot">&lt;-</span> expect</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">  liftIO <span class="fu">$</span> putMVar mvar msg</a></code></pre></div>
<p>Using these functions, weâ€™ll write our first test. Itâ€™s important that weâ€™re confident our application spins up all of the relevant processes it needs to function correctly. Weâ€™ll do this by starting our application, checking whether the process is registered and putting the result in our <a href="http://hackage.haskell.org/package/base-4.12.0.0/docs/Control-Concurrent-MVar.html#t:MVar"><code>MVar</code></a>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co">-- SPECS</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">main <span class="fu">=</span> hspec <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  <span class="kw">let</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">    double mvar node <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8">      _ <span class="ot">&lt;-</span> app node</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">      x <span class="ot">&lt;-</span> whereis <span class="st">&quot;client&quot;</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10">      y <span class="ot">&lt;-</span> whereis <span class="st">&quot;server&quot;</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11">      liftIO <span class="fu">$</span> putMVar mvar [x, y]</a>
<a class="sourceLine" id="cb5-12" data-line-number="12"></a>
<a class="sourceLine" id="cb5-13" data-line-number="13">  aroundApp double <span class="fu">$</span></a>
<a class="sourceLine" id="cb5-14" data-line-number="14">    describe <span class="st">&quot;app&quot;</span> <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15">      it <span class="st">&quot;should spin up every process&quot;</span> <span class="fu">$</span> \(mvar, _) <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb5-16" data-line-number="16">        mbPids <span class="ot">&lt;-</span> takeMVar mvar</a>
<a class="sourceLine" id="cb5-17" data-line-number="17">        any isNothing mbPids <span class="ot">`shouldBe`</span> <span class="dt">False</span></a></code></pre></div>
<p>From here weâ€™ll want to test that our processes communicate â€” i.e.Â send and receive appropriate messages â€” with one another as we expect. We do this by starting a client process and registering a server <a href="https://martinfowler.com/bliki/TestDouble.html">test double</a> thatâ€™ll listen for messages sent to it using the <code>writer</code> function.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" data-line-number="1">  <span class="kw">let</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">    double mvar node <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">      _ <span class="ot">&lt;-</span> newProcess node <span class="st">&quot;client&quot;</span> clientProcess</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">      _ <span class="ot">&lt;-</span> newProcess node <span class="st">&quot;server&quot;</span> <span class="fu">$</span> writer mvar</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">      pure ()</a>
<a class="sourceLine" id="cb6-6" data-line-number="6"></a>
<a class="sourceLine" id="cb6-7" data-line-number="7">  aroundApp double <span class="fu">$</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8">    describe <span class="st">&quot;Ask ints&quot;</span> <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9">      it <span class="st">&quot;should call the server process&quot;</span> <span class="fu">$</span> \(mvar, node) <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10">        _ <span class="ot">&lt;-</span> forkProcess node <span class="fu">$</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11">          namedSend <span class="st">&quot;client&quot;</span> (<span class="dt">Ask</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>])</a>
<a class="sourceLine" id="cb6-12" data-line-number="12"></a>
<a class="sourceLine" id="cb6-13" data-line-number="13">        <span class="dt">Calc</span> _ ints <span class="ot">&lt;-</span> takeMVar mvar</a>
<a class="sourceLine" id="cb6-14" data-line-number="14">        ints <span class="ot">`shouldBe`</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>]</a></code></pre></div>
<p>Finally weâ€™ll want to test our server process calculates results correctly and sends them back to clients. We do this by starting our server process and sending a message to it from a <a href="https://martinfowler.com/bliki/TestDouble.html">test double</a> client process.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" data-line-number="1">  <span class="kw">let</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">    double mvar node <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3">      void <span class="fu">$</span> newProcess node <span class="st">&quot;server&quot;</span> serverProcess</a>
<a class="sourceLine" id="cb7-4" data-line-number="4"></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">  aroundApp double <span class="fu">$</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6">    describe <span class="st">&quot;Result i&quot;</span> <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7">      it <span class="st">&quot;should call the client process with the result&quot;</span> <span class="fu">$</span> \(mvar, node) <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8">        _ <span class="ot">&lt;-</span> forkProcess node <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9">          pid <span class="ot">&lt;-</span> newProcess node <span class="st">&quot;client&quot;</span> <span class="fu">$</span> writer mvar</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">          namedSend <span class="st">&quot;server&quot;</span> <span class="fu">$</span> <span class="dt">Calc</span> pid [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>]</a>
<a class="sourceLine" id="cb7-11" data-line-number="11"></a>
<a class="sourceLine" id="cb7-12" data-line-number="12">        <span class="dt">Result</span> i <span class="ot">&lt;-</span> takeMVar mvar</a>
<a class="sourceLine" id="cb7-13" data-line-number="13">        i <span class="ot">`shouldBe`</span> <span class="dv">10</span></a></code></pre></div>
<h2 id="conclusion">Conclusion</h2>
<p>The approach described in this post reflects some of my background in object-oriented programming. After all, spinning up processes and testing messages passed between them feels very similar to instantiating objects and doing the same thing.</p>
<p>There are obviously some shortcomings to the techniques described â€” the big one being that the type checker doesnâ€™t complain when you send an unknown message to a process. That said, the approach <a href="https://github.com/haskell-distributed/distributed-process"><code>distributed-process</code></a> makes you to take is very consistent and makes it pleasant to write asynchronous applications.</p>
<p>Hopefully what Iâ€™ve written here offers some insight into how you might begin testing your <a href="https://github.com/haskell-distributed/distributed-process"><code>distributed-process</code></a> applications.</p>
    </div>
  </section>
</div>

      </div>
    </div>
  </body>
</html>
